--- 
title: "Reproducible GIS analysis with R"
author: "[Phil Hurvitz](mailto:phurvitz@uw.edu)"
date: '`r format(Sys.time(), "%Y-%m-%d %H:%M")`'
site: bookdown::bookdown_site
output: bookdown::html_document2
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
description: "Manual for CSDE Workshop 'Reproducible GIS analysis with R'"
---

# Introduction

Placeholder


## R code used in this document
## Complete Rmd code

<!--chapter:end:index.Rmd-->


# Getting started {#getting_started}

Placeholder


## Install necessary packages
## Create an RStudio project
## Download files
## Preview data
## Save your project

<!--chapter:end:010-getting_started.Rmd-->


# Representation of spatial features {#representation}

Placeholder


## Points {#points}
## Linestrings
## Polygons
## Conclusion

<!--chapter:end:020-representation.Rmd-->


# Importing and exporting spatial data sets {#import-export}

Placeholder


## Importing spatial data sets
## Exporting spatial data {#export}

<!--chapter:end:030-import_export.Rmd-->


# Handling projections and coordinate systems {#crs}

Placeholder


## Projections and coordinate systems
## On-the-fly projection in desktop GIS
## Defining a data set's coordinate reference system
## Coordinate transformation

<!--chapter:end:040-crs.Rmd-->


# Geoprocessing {#geoprocessing}

Placeholder


## Buffering
## Point-in-polygon
## Polygon-on-polygon
### Intersect
### Union

<!--chapter:end:050-overlay.Rmd-->

# `leaflet` and `mapview` maps {#leaflet}
```{r}
library(leaflet)
library(mapview)
library(htmltools)

# path to this file name
if (!interactive()) {
    fnamepath <- current_input(dir = TRUE)
} else {
    fnamepath <- ""
}
```

This exercise will introduce construction of a Leaflet map using the `leaflet` package. Also simple interface uses the `mapview::mapview()` function, which automatically adds the OpenStreetMap background, uses pre-loaded colors, and with the `legend = TRUE` option also adds a map legend.

```{r}
mapview(nhood_pov, zcol = "pct_pov", legend = TRUE)
```

We will now build up a map using `leaflet()` for a bit more control.

```{r}
# CRS
nhood_pov_4326 <- nhood_pov %>% st_transform(4326)

# make a label with the count of persons, persons below poverty, and % poverty
nhood_pov_4326$mylab <- sprintf("n_pov=%s<br>n=%s<br>%s<br>", 
                                round(nhood_pov_4326$n_pov, 0), 
                                round(nhood_pov_4326$n, 0), 
                                paste("pov=", nhood_pov_4326$pct_pov, "%", sep=""))

l <- leaflet(data = nhood_pov_4326) %>%
    addPolygons(popup = ~mylab, weight = 2) %>%
    addTiles()
l
```

Let's change the labels to include neighborhood name and % poverty, add choropleth fill and a legend:

```{r}
# CRS
nhood_pov_4326 <- nhood_pov %>% st_transform(4326)

mypalette <- colorQuantile(palette = "viridis", domain = nhood_pov_4326$pct_pov, n = 4)

# make a label with the count of persons, persons below poverty, and % poverty
nhood_pov_4326$mylab <- sprintf("%s<br>%s<br>", 
                                nhood_pov_4326$gen_alias, 
                                paste("pov=", nhood_pov_4326$pct_pov, "%", sep=""))

l <- leaflet(data = nhood_pov_4326) %>%
    addPolygons(popup = ~mylab, 
                weight = 2, 
                fillColor = ~mypalette(pct_pov),
                opacity = 0.7) %>%
    addTiles() %>%
    addLegend(pal=mypalette, values=~pct_pov, opacity=0.7, title = "% below poverty", position = "bottomleft" )

l
```

Finally, add the hospitals with a label that will display when hovering over the point marker.

```{r}
# CRS
nhood_pov_4326 <- nhood_pov %>% st_transform(4326)

# hospitals
hospitals <- st_read(file.path(mydatadir, "medical_facilities", "medical_facilities.shp"), quiet = TRUE) %>% st_transform(4326)

mypalette <- colorQuantile(palette = "viridis", domain = nhood_pov_4326$pct_pov, n = 4)

# make a label with the count of persons, persons below poverty, and % poverty
nhood_pov_4326$mylab <- sprintf("%s<br>%s<br>", 
                                nhood_pov_4326$gen_alias, 
                                paste("pov=", nhood_pov_4326$pct_pov, "%", sep=""))

l <- leaflet(data = nhood_pov_4326) %>%
    addPolygons(popup = ~mylab, 
                weight = 2, 
                fillColor = ~mypalette(pct_pov),
                opacity = 0.7) %>%
    addTiles() %>%
    addLegend(pal=mypalette, values=~pct_pov, opacity=0.7, title = "% below poverty", position = "bottomleft" )

l <- addCircleMarkers(map = l, 
                     data = hospitals,
                     radius = 5, 
                     weight = 1,
                     opacity = 0.9,
                     fillOpacity = 0.5,
                     label = ~ABB_NAME)

l
```

# Source code
File is at `r fnamepath`.

## R code used in this document
```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

## Complete Rmd code
```{r comment=''}
cat(readLines(fnamepath), sep = '\n')
```



<!--chapter:end:070-leaflet.Rmd-->

